<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Plane : " />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Plane</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/SangBaisong/Plane">View on GitHub</a>

          <h1 id="project_title">Plane</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/SangBaisong/Plane/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/SangBaisong/Plane/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="plane---natp%E9%A1%B9%E7%9B%AE" class="anchor" href="#plane---natp%E9%A1%B9%E7%9B%AE"><span class="octicon octicon-link"></span></a>Plane - Natp项目</h1>

<h3>
<a name="%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82" class="anchor" href="#%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="octicon octicon-link"></span></a>环境要求：</h3>

<pre><code>Ubuntu 12.04
Python2.7   GNURadio/RTL-SDR dependencies
probe package (local configure files,command line tools-modes_probe)
Restful Web Service:Nginx+uWsgi+Django
MySQL
Google Earth
</code></pre>

<h3>
<a name="%E7%8E%AF%E5%A2%83%E5%AE%9E%E7%8E%B0" class="anchor" href="#%E7%8E%AF%E5%A2%83%E5%AE%9E%E7%8E%B0"><span class="octicon octicon-link"></span></a>环境实现：</h3>

<h5>
<a name="python-27-%E7%94%A8-ubuntu-%E8%87%AA%E5%B8%A6%E5%8D%B3%E5%8F%AF" class="anchor" href="#python-27-%E7%94%A8-ubuntu-%E8%87%AA%E5%B8%A6%E5%8D%B3%E5%8F%AF"><span class="octicon octicon-link"></span></a>Python 2.7 用 Ubuntu 自带即可</h5>

<h5>
<a name="%E5%AE%89%E8%A3%85-gnuradio%E5%BA%93" class="anchor" href="#%E5%AE%89%E8%A3%85-gnuradio%E5%BA%93"><span class="octicon octicon-link"></span></a>安装 GNURadio库：</h5>

<pre><code>    方法1: 下载最新源码http://gnuradio.org/redmine/projects/gnuradio/wiki 
          编译安装
    方法2: wget http://www.sbrac.org/files/build-gnuradio
          chmod +x build-gnuradio
          ./build-gnuradio –verbose
    GNURadio库编译安装时间较⻓长,需80-100分钟
</code></pre>

<h5>
<a name="%E5%AE%89%E8%A3%85-rlt-sdr--gr-osmosdr%E5%BA%93" class="anchor" href="#%E5%AE%89%E8%A3%85-rlt-sdr--gr-osmosdr%E5%BA%93"><span class="octicon octicon-link"></span></a>安装 rlt-sdr / gr-osmosdr库：</h5>

<pre><code>    git clone git://git.osmocom.org/rtl-sdr.git •cd rtl-sdr/
    mkdir build
    cd build
    cmake ../ -DINSTALL_UDEV_RULES=ON 
    make
    sudo make install
    sudo ldconfig

    git clone git://git.osmocom.org/gr-osmosdr •cd gr-osmosdr/
    mkdir build
    cd build/
    cmake ../
    make
    sudo make install •sudo ldconfig
</code></pre>

<h5>
<a name="%E9%AA%8C%E8%AF%81-rlt-sdr--gr-osmosdr%E5%BA%93-%E7%94%B5%E8%A7%86%E6%A3%92%E6%8E%A5pc" class="anchor" href="#%E9%AA%8C%E8%AF%81-rlt-sdr--gr-osmosdr%E5%BA%93-%E7%94%B5%E8%A7%86%E6%A3%92%E6%8E%A5pc"><span class="octicon octicon-link"></span></a>验证 rlt-sdr / gr-osmosdr库 (电视棒接PC)：</h5>

<pre><code>    rtl_eeprom •查看rtl-sdr设备信息
    rtl_test •采样测试
    rtl_sdr 
    rtl_fm 
    rtl_tcp
</code></pre>

<h5>
<a name="%E5%AE%89%E8%A3%85-gr-air-modes-%E5%B7%A5%E5%85%B7" class="anchor" href="#%E5%AE%89%E8%A3%85-gr-air-modes-%E5%B7%A5%E5%85%B7"><span class="octicon octicon-link"></span></a>安装 gr-air-modes 工具：</h5>

<pre><code>    git clone https://github.com/bistromath/gr-air-modes.git •cd gr-air-modes
    mkdir build
    cd build
    cmake ../
    make
    sudo make install •sudo ldconfig
    测试安装结果：modes_rx –help      modes_gui
</code></pre>

<h5>
<a name="%E5%AE%89%E8%A3%85-ngnix" class="anchor" href="#%E5%AE%89%E8%A3%85-ngnix"><span class="octicon octicon-link"></span></a>安装 Ngnix：</h5>

<pre><code>    参考：http://wiki.ubuntu.org.cn/Nginx
</code></pre>

<h5>
<a name="%E5%AE%89%E8%A3%85-google-earth" class="anchor" href="#%E5%AE%89%E8%A3%85-google-earth"><span class="octicon octicon-link"></span></a>安装 Google Earth：</h5>

<pre><code>    参考：http://wiki.ubuntu.com.cn/Google_Earth 
</code></pre>

<h3>
<a name="natp_server" class="anchor" href="#natp_server"><span class="octicon octicon-link"></span></a>NATP_SERVER:</h3>

<pre><code>信息汇聚检索服务，modes信息导出到KML文件中，DB Schema
接口report接收natp_probe汇报的请求；
解析请求中的SQL记录后，写入MySQL数据库中；
页面展示信息；
接口定时更新kml输出；
部署时采用https;
查询时采用memcached缓存；
</code></pre>

<h3>
<a name="%E5%AE%A2%E6%88%B7%E7%AB%AFnatp-modes" class="anchor" href="#%E5%AE%A2%E6%88%B7%E7%AB%AFnatp-modes"><span class="octicon octicon-link"></span></a>客户端（natp-modes）</h3>

<p>前端负责收集飞机信号，并且解码，将结果传送给服务器端。基本上基于gr-air-modes。但是添加了向服务器汇报的功能。包括：数据汇报格式的定义，定时汇报机制，数据加密等。</p>

<h5>
<a name="%E6%95%B0%E6%8D%AE%E6%B1%87%E6%8A%A5%E6%A0%BC%E5%BC%8F" class="anchor" href="#%E6%95%B0%E6%8D%AE%E6%B1%87%E6%8A%A5%E6%A0%BC%E5%BC%8F"><span class="octicon octicon-link"></span></a>数据汇报格式</h5>

<p>数据汇报格式采用xml1.0，添加了自定义元素sql，probe，content，下面是一个例子：</p>

<pre><code>&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;sql&gt;
&lt;probe&gt;first_probe&lt;/probe&gt;
&lt;content&gt;{'values': {'icao': '7867259', 'seen': '2013-11-26 13:29:55', 'speed': '444', 'heading': '7', 'vertical': '-128'}, 'table_name': 'vectors'}
&lt;/content&gt;
&lt;content&gt;{'values': {'icao': '7867259', 'seen': '2013-11-26 13:29:55', 'alt': '35125', 'lat': '40.257568', 'lon': '116.759277'}, 'table_name': 'positions'}
&lt;/content&gt;
&lt;content&gt;{'values': {'icao': '7857259', 'ident': 'CSN3615'}, 'table_name': 'ident'}&lt;/content&gt;
&lt;/sql&gt;
</code></pre>

<p>probe对应服务器端中的probe数据来源，每一行数据都由content包含，数据含义如下(根据数据含义分成3类)</p>

<pre><code>table_name对应服务器端的3个数据库表，也代表3中消息类别

Ident
icao 标识飞机
ident 飞机航班号

Vector
icao 同上
seen，该条消息被解析的时间（可以粗略认为是飞机在该时刻的信息）
speed 飞机水平速度
heading 以北东南西顺时针方向的角度，北为0度
vertical 竖直速度

Position
icao 同上
seen 同上
alt  高度（altitude）
lat  纬度（latitude）
lon  经度（longtitude）
</code></pre>

<h5>
<a name="%E5%AE%9A%E6%97%B6%E6%B1%87%E6%8A%A5%E6%9C%BA%E5%88%B6" class="anchor" href="#%E5%AE%9A%E6%97%B6%E6%B1%87%E6%8A%A5%E6%9C%BA%E5%88%B6"><span class="octicon octicon-link"></span></a>定时汇报机制</h5>

<p>每个客户端都有一个配置文件，文件内容如下</p>

<pre><code>[general]

log_file = XXXX/natp_modes.log
probe_name = first_probe

[net_reporter]
endpoint = http://XXXX/report/
timeout = 180s
max_rep_num = 200
client_cert = XXXXXX/client.crt
ca_cert = XXXXX/ca.crt
</code></pre>

<p>其中timeout为每隔多少时间汇报一次(如果消息个数未0则不汇报)，而max_rep_num是每次汇报的大小（以免数据过大，传送失败，以及考虑服务器端处理事件）</p>

<h5>
<a name="%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86" class="anchor" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="octicon octicon-link"></span></a>数据加密</h5>

<p>客户端传送数据到服务器端采用https协议，保证数据的安全。</p>

<h3>
<a name="%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF" class="anchor" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF"><span class="octicon octicon-link"></span></a>服务器端</h3>

<p>服务器端集中处理客户端发送过来的数据，并进行展示(展示包括数据展示以及google KML文件导出展示)。主要技术包括：使用nginx服务器，django框架，https的支持，系统后台任务调度，查询缓存等。</p>

<h5>
<a name="%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6" class="anchor" href="#%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="octicon octicon-link"></span></a>系统后台任务调度</h5>

<p>由于多个客户端同时发送数据到服务器端，以及数据动态导出展示需要，增加系统后台任务调度功能。利用celery（开源项目，自称是分布式任务调度队列）来实现服务器不处理请求，而将任务交给系统的celery守护进程处理。</p>

<h5>
<a name="%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98" class="anchor" href="#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="octicon octicon-link"></span></a>查询缓存</h5>

<p>由于每次请求查询数据都需要很多时间，利用memcache缓存系统，通过将相同请求中的第一次请求结果存储，来实现快速查询。</p>

<h5>
<a name="google-kml%E6%96%87%E4%BB%B6%E5%AF%BC%E5%87%BA%E7%AE%97%E6%B3%95" class="anchor" href="#google-kml%E6%96%87%E4%BB%B6%E5%AF%BC%E5%87%BA%E7%AE%97%E6%B3%95"><span class="octicon octicon-link"></span></a>google kml文件导出算法</h5>

<p>导出支持动态和静态导出，静态导出则根据给定的时间范围导出一个kml文件，并下载给用户，用户通过google earth等工具查看飞机。动态导出则是给定一个kml的url给用户，用户也是通过google earth查看，但是这个kml文件内容会动态变化，根据用户给定的时间间隔，生成给定时间内的飞机信息。<br>
生成kml算法</p>

<pre><code>Input: start：开始时间
       end：结束时间
       freq：查询飞机时间范围长度
       window_size: 查询飞机信息的历史时间
Output: 包含飞机信息kml格式的文件

cursor: initially equals start
front: initially equals start + freq
back: initially equals start - window_size

    while True:
        back = cursor - window_size
        cursor = front
        front = front + freq

        if front &lt; end:
            kml = search(back, front)
        elif front &gt; end:
            front = end
            kml = search(back, front)
        else:
            kml = search(back, front)
            break
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Plane maintained by <a href="https://github.com/SangBaisong">SangBaisong</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
